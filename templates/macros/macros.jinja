{%- macro besuNodes(nodeConfig) %}
{% set bootnode = nodeConfig | firstByAttr('boot', true) %}
{% set memberPort = 20000 %}
{% set rpcPort = 8545 %}
{% set besuNodes = nodeConfig | byNotAttr('type', 'orion') | byNotAttr('type', 'orion-proxy') | byNotAttr('type', 'firewall') %}
{% for node in besuNodes %}
{% set isValidator = 'validator' == node.roles | firstByValue('validator') %}
{% set isMember = 'member' == node.roles | firstByValue('member') %}
{% set isRPC = 'rpc' == node.roles | firstByValue('rpc') %}
{%- set orionnode = nodeConfig | firstByAttr('name', node.orion) %}
{% if isValidator or isMember or isRPC %}
{% if isMember %}
  {{ node.name}}besu:
{% else %}
  {{ node.name}}:
{% endif %}
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
{% if node.boot %}
        /opt/besu/bin/besu public-key export --to=/tmp/bootnode_pubkey;
{% elif not enableStaticNodes %}
        while [ ! -f "/opt/besu/public-keys/bootnode_pubkey" ]; do sleep 5; done ;
{% endif %}
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
{%- if privacy and isMember %}
        --privacy-enabled \
        --privacy-url=http://{{- node.name}}orion:8888 \
        --privacy-public-key-file=/config/orion/orion.pub \
        --privacy-onchain-groups-enabled={{- privacyOnchainGroupsEnabled}} \
{%- endif %}
{%- if p2pSSL %}
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
{%- endif %}
        --rpc-http-api=EEA,WEB3,ETH,NET,{% if privacy %}PRIV,{% endif %}PERM,{{- besuConsApi}} \
        --rpc-ws-api=EEA,WEB3,ETH,NET,{% if privacy %}PRIV,{% endif %}PERM,{{- besuConsApi}} ;
    volumes:
{% if node.boot %}
      - public-keys:/tmp/
{% else %}
      - public-keys:/opt/besu/public-keys/
{% endif %}
      - ./config/besu/config.toml:/config/config.toml
{% if enableNodePermissions %}
      - ./config/besu/permissions_config.toml:/config/permissions_config.toml
{% endif %}
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/{{- besuConsAlgo}}Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/{{- node.name}}/keys:/opt/besu/keys
{% if privacy and isMember %}
      - ./config/orion/networkFiles/{{- orionnode.name}}/nodeKey.pub:/config/orion/orion.pub
{% endif %}
{% if p2pSSL %}
{% if privacy and isMember %}
      - ./config/besu/p2p-ssl/{{- node.name}}besu:/opt/besu/p2p-ssl
{% else %}
      - ./config/besu/p2p-ssl/{{- node.name}}:/opt/besu/p2p-ssl
{% endif %}
{% endif %}
{% if enableStaticNodes %}
      - ./config/besu/static-nodes.json:/config/static-nodes.json
{% endif %}
{% if (isMember and privacy) or (bootnode and node.name != bootnode.name) %}
    depends_on:
{% if isMember and privacy %}
      - {{ node.name}}orion
{% endif %}
{% if bootnode and node.name != bootnode.name %}
      - {{ bootnode.name}}
{% endif %}
{% endif %}
{% if isRPC or isMember %}
    ports:
{% if isRPC %}
      - {{rpcPort}}:8545/tcp
      - {{rpcPort+1}}:8546/tcp
      - {{rpcPort+2}}:8547/tcp
{% set rpcPort = rpcPort + 3 %}
{% endif %}
{% if isMember %}
      - {{memberPort}}:8545/tcp
      - {{memberPort+1}}:8546/tcp
      - {{memberPort+2}}:8547/tcp
{% set memberPort = memberPort + 3 %}
{% endif %}
{% endif %}
    networks:
{% for network in node.networks %}
      {{network}}:
{%- if not enableDNS %}
        ipv4_address: {{ node.ip}}
{%- endif %}
{% endfor %}

{% if isMember and privacy %}
{% set otherOrions = nodeConfig | byAttr('type', 'orion') | byNotAttr('name', orionnode.name) %}
{% if otherOrions %}
{% set otherNodes = nodeConfig | byArr(otherOrions, 'orion', 'name') %}
  {{ node.name}}orion:
    image: consensys/quorum-orion:${QUORUM_ORION_VERSION:-latest}
    command: ["/config/orion.conf"]
    environment:
{%- if 0 < otherNodes | length %}    
      - ORION_OTHERNODES={% for otherOrion in otherNodes %}http://{{- otherOrion.name}}orion:8080/{{',' if not loop.last}}{% endfor %}
{%- endif %}
      - ORION_NODEURL=http://{{- node.name}}orion:8080
      - ORION_CLIENTURL=http://{{- node.name}}orion:8888
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    volumes:
      - ./config/orion/orion.conf:/config/orion.conf
      - ./config/orion/networkFiles/{{- orionnode.name}}:/keys/
      - ./logs/orion:/tmp/orion
      - ./config/orion/log-config.xml:/config/log-config.xml
    networks:
{% for network in node.networks %}
      {{network}}:
{% if not enableDNS %}
        ipv4_address: {{ orionnode.ip}}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}

{% endif %}
{% endfor %}
{% endmacro %}

{%- macro proxies(nodeConfig) %}
{% set proxies = nodeConfig | byAttr('type', 'orion-proxy') %}
{% set statsPort = 13037 %}
{% for node in proxies %}
  {{ node.name}}:
    restart: "on-failure"
    image: haproxy:${HAPROXY_VERSION:-latest}
    volumes:
      - ./config/haproxy/{{node.name}}.cfg:/usr/local/etc/haproxy/haproxy.cfg
    ports:
      - {{statsPort}}:12037
{% set statsPort = statsPort + 1 %}
    networks:
{% for network in node.networks %}
      {{network}}:
{% endfor %}
{% endfor %}
{% endmacro %}

{%- macro firewalls(nodeConfig) %}
{% set firewalls = nodeConfig | byAttr('type', 'firewall') %}
{% set statsPort = 12037 %}
{% set firewallPort = 20000 %}
{% for node in firewalls %}
  {{ node.name}}:
    restart: "on-failure"
    image: haproxy:${HAPROXY_VERSION:-latest}
    volumes:
      - ./config/haproxy/{{node.name}}.cfg:/usr/local/etc/haproxy/haproxy.cfg
    ports:
      - {{statsPort}}:12037
      - {{firewallPort}}:20000
{% set statsPort = statsPort + 1 %}
{% set firewallPort = firewallPort + 1 %}
    networks:
{% for network in node.networks %}
      {{network}}:
{% endfor %}
{% endfor %}
{% endmacro %}

{%- macro haproxyOrion(nodeConfig) %}
{% set nodes = nodeConfig | byAttr('type', 'orion-proxy') %}
{% set orionPort = 8081 %}
{% for node in nodes %}
{% set nodeName = node.name | replace('firewall', 'orion') %}
listen {{nodeName}}
    bind *:{{orionPort}}
{% set orionPort = orionPort + 1 %}
    mode http
    server {{nodeName}} {{node.name}}:8080 verify required check port 8080
{% endfor %}
{% endmacro %}

{%- macro haproxyFirewall(nodeConfig, network) %}
{% set firewalls = nodeConfig | byAttr('type', 'firewall') %}
{% set orionPort = 8081 %}
{% for firewall in firewalls %}
{% set nodeName = firewall.name | replace('firewall', 'orion') %}
listen {{nodeName}}
    bind *:{{orionPort}}
{% set orionPort = orionPort + 1 %}
    mode http
    server {{nodeName}} {{firewall.name}}:8080 verify required check port 8080
{% endfor %}
{% endmacro %}
